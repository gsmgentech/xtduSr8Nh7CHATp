;(function () {
  const $ = i => document.getElementById(i)

  const order = JSON.parse(sessionStorage.getItem('order') || '{}')

  if (!order.service || !order.unitPrice) {
    location.replace('index.html')
    return
  }

  const titleEl = document.querySelector('.page-title')
  const summaryEl = $('summary')
  const totalEl = $('totalPrice')
  const unitEl = $('unitPrice')
  const unitWrap = $('unitWrap')
  const emailEl = $('email')
  const qtyWrap = $('qtyWrap')
  const qtyInput = $('quantity')
  const fieldsWrap = $('dynamicFields')
  const btn = $('continueBtn')

  titleEl.textContent = order.service
  summaryEl.hidden = false

  let qty = order.quantity || 1
  const unit = Number(order.unitPrice)

  function updateTotal() {
    const total = unit * qty
    totalEl.textContent = total.toFixed(2)

    order.quantity = qty
    order.subtotal = total
    sessionStorage.setItem('order', JSON.stringify(order))
  }

  if (order.allowQuantity) {
    qtyWrap.hidden = false
    unitWrap.hidden = false
    unitEl.textContent = unit.toFixed(2)

    $('minus').onclick = () => {
      if (qty > 1) {
        qty--
        qtyInput.value = qty
        updateTotal()
      }
    }

    $('plus').onclick = () => {
      qty++
      qtyInput.value = qty
      updateTotal()
    }
  }

  function addField(id, labelText) {
    const wrap = document.createElement('div')
    wrap.className = 'section'

    const label = document.createElement('label')
    label.textContent = labelText

    const input = document.createElement('input')
    input.id = id
    input.required = true

    input.oninput = e => {
      order[id] = e.target.value.trim()
    }

    wrap.appendChild(label)
    wrap.appendChild(input)
    fieldsWrap.appendChild(wrap)
  }

  if (order.requiresIMEI) {
    addField('imei', 'IMEI')
  }

  if (order.requiresSerial) {
    addField('serial', 'Serial Number')
  }

  if (order.requiresUnlockCode) {
    addField('unlockCode', 'Unlock Code')
  }

  updateTotal()

  btn.onclick = () => {
    const email = emailEl.value.trim()
    if (!email) {
      alert('Email is required')
      emailEl.focus()
      return
    }

    const requiredInputs = fieldsWrap.querySelectorAll('input')
    for (const input of requiredInputs) {
      if (!input.value.trim()) {
        const label = input.previousElementSibling
        alert(`${label ? label.textContent : 'This field'} is required`)
        input.focus()
        return
      }
    }

    order.email = email
    order.orderId = generateOrderId()
    sessionStorage.setItem('order', JSON.stringify(order))
    location.href = 'payment.html'
  }

  function generateOrderId() {
    const d = new Date()
    return (
      'GTS-' +
      d.getFullYear() +
      '-' +
      String(d.getMonth() + 1).padStart(2, '0') +
      String(d.getDate()).padStart(2, '0') +
      String(d.getHours()).padStart(2, '0') +
      String(d.getMinutes()).padStart(2, '0') +
      String(d.getSeconds()).padStart(2, '0')
    )
  }
})()

document.getElementById('backBtn')?.addEventListener('click', () => {
  history.back()
})
