;(function () {
  const $ = id => document.getElementById(id)

  const order = JSON.parse(sessionStorage.getItem('order') || '{}')

  if (!order.orderId || !order.subtotal) {
    location.replace('index.html')
    return
  }

  const baseEl = $('baseAmount')
  const discountEl = $('discountAmount')
  const finalEl = $('finalAmount')
  const voucherEl = $('voucher')
  const applyBtn = $('applyVoucher')
  const msgEl = $('voucherMsg')

  /* =========================
     VOUCHER CONFIG (CASE-SENSITIVE)
  ========================= */
  const VALID_VOUCHER = '3JAYGY1F'
  const DISCOUNT_VALUE = Infinity

  let discount = 0
  let lastSubtotal = order.subtotal

  /* =========================
     HELPERS
  ========================= */
  function saveOrder() {
    sessionStorage.setItem('order', JSON.stringify(order))
  }

  function updateTotals() {
    const final = Math.max(0, order.subtotal - discount)

    baseEl.textContent = order.subtotal.toFixed(2)
    discountEl.textContent = discount.toFixed(2)
    finalEl.textContent = final.toFixed(2)

    if (discount > 0) {
      baseEl.classList.add('striked')
    } else {
      baseEl.classList.remove('striked')
    }

    order.discount = discount
    order.finalPrice = final
    saveOrder()
  }

  function markVoucherApplied(message) {
    voucherEl.readOnly = true
    voucherEl.classList.add('voucher-applied')

    applyBtn.textContent = 'Remove'
    applyBtn.classList.add('remove-mode')

    msgEl.textContent = message
    msgEl.style.color = '#16a34a'
  }

  function resetVoucher(message) {
    discount = 0
    order.discount = 0
    order.voucherUsed = false
    order.voucherCode = null

    voucherEl.readOnly = false
    voucherEl.classList.remove('voucher-applied')
    voucherEl.value = ''

    applyBtn.textContent = 'Apply'
    applyBtn.classList.remove('remove-mode')

    msgEl.textContent = message || ''
    msgEl.style.color = '#dc2626'

    updateTotals()
  }

  /* =========================
     AUTO-HIDE ERROR ON TYPING
  ========================= */
  voucherEl.addEventListener('input', () => {
    if (!order.voucherUsed) {
      msgEl.textContent = ''
    }
  })

  /* =========================
     APPLY / REMOVE VOUCHER
  ========================= */
  applyBtn.onclick = () => {
    // REMOVE MODE
    if (order.voucherUsed) {
      resetVoucher('Voucher removed')
      return
    }

    // APPLY MODE
    const code = voucherEl.value.trim()

    if (!code) {
      msgEl.textContent = 'Please enter voucher code'
      msgEl.style.color = '#dc2626'
      return
    }

    if (code !== VALID_VOUCHER) {
      msgEl.textContent = 'Invalid voucher code'
      msgEl.style.color = '#dc2626'
      return
    }

    discount = Math.min(DISCOUNT_VALUE, order.subtotal)
    order.voucherUsed = true
    order.voucherCode = VALID_VOUCHER

    updateTotals()
    markVoucherApplied('Voucher applied successfully')
  }

  /* =========================
     AUTO-REMOVE ON SUBTOTAL CHANGE
  ========================= */
  function watchSubtotalChange() {
    const latest = JSON.parse(sessionStorage.getItem('order') || '{}')
    if (!latest.subtotal) return

    if (latest.subtotal !== lastSubtotal) {
      lastSubtotal = latest.subtotal
      order.subtotal = latest.subtotal

      if (order.voucherUsed) {
        resetVoucher('Voucher removed due to price change')
      } else {
        updateTotals()
      }
    }
  }

  setInterval(watchSubtotalChange, 500)

  /* =========================
     INIT (RESTORE STATE)
  ========================= */
  if (order.voucherUsed && order.voucherCode === VALID_VOUCHER) {
    discount = Math.min(DISCOUNT_VALUE, order.subtotal)
    voucherEl.value = order.voucherCode
    updateTotals()
    markVoucherApplied('Voucher applied successfully')
  } else {
    updateTotals()
  }
})()

document.getElementById('backBtn')?.addEventListener('click', () => {
  history.back()
})
