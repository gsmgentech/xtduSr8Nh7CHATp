(() => {

  /* =========================
     BOTTOM NAV
  ========================= */
  const currentPage = location.pathname.split('/').pop() || 'index.html'
  const params = new URLSearchParams(location.search)
  const from = params.get('from')

  const navItems = [
    { href: 'imei.html', icon: 'fa-fingerprint', label: 'IMEI' },
    { href: 'server.html', icon: 'fa-cloud', label: 'Server' },
    { href: 'index.html', icon: 'fa-house', label: 'Home' },
    { href: 'rent.html', icon: 'fa-clock', label: 'Rent' },
    { href: 'orders.html', icon: 'fa-receipt', label: 'Orders' }
  ]

  const nav = document.createElement('div')
  nav.className = 'nav'

  navItems.forEach(item => {
    const a = document.createElement('a')
    a.href = item.href

    const key = item.href.replace('.html', '')
    if (
      item.href === currentPage ||
      (currentPage === 'checkout.html' && from === key)
    ) {
      a.classList.add('active')
    }

    a.innerHTML = `<i class="fa ${item.icon}"></i><span>${item.label}</span>`
    nav.appendChild(a)
  })

  document.body.appendChild(nav)

  /* =========================
      MENU OVERLAY (PRO)
    ========================= */
  document.body.insertAdjacentHTML('beforeend', `
    <div class="menu-overlay" id="menuOverlay">
      <div class="menu-drawer">
        <div class="menu-header">
          <span>Menu</span>
          <i class="fa fa-times" id="closeMenu"></i>
        </div>

        <div class="menu-section">
          <div class="menu-item" id="menuDark">
            <i class="fa fa-moon" id="themeIcon"></i>
            <span id="themeLabel">Dark Mode</span>
          </div>

          <div class="menu-item" id="menuNotifications">
            <i class="fa fa-bell"></i>
            <span>Notifications</span>
          </div>

          <div class="menu-item" id="menuLanguage">
            <i class="fa fa-language"></i>
            <span>Language</span>
          </div>

          <!-- EXISTING: REFUND -->
          <div class="menu-item" id="menuRefund">
            <i class="fa fa-rotate-left"></i>
            <span>Refund</span>
          </div>

          <div class="menu-item" id="menuHelpCenter">
            <i class="fa fa-circle-question"></i>
            <span>Help Center</span>
          </div>

          <div class="menu-item" id="menuContactSupport">
            <i class="fa fa-headset"></i>
            <span>Contact Support</span>
          </div>

          <div class="menu-item" id="menuFAQ">
            <i class="fa fa-comments"></i>
            <span>FAQ</span>
          </div>

          <div class="menu-item" id="menuClearCache">
            <i class="fa fa-trash"></i>
            <span>Clear Cache</span>
          </div>

          <div class="menu-item" id="menuTerms">
            <i class="fa fa-file-contract"></i>
            <span>Terms & Conditions</span>
          </div>

          <div class="menu-item" id="menuPrivacyPolicy">
            <i class="fa fa-user-shield"></i>
            <span>Privacy Policy</span>
          </div>

          <div class="menu-item" id="menuVersion">
            <i class="fa fa-code"></i>
            <span>Version</span>
          </div>
        </div>

      </div>
    </div>
  `)

  const menuToggle = document.getElementById('menuToggle')
  const menuOverlay = document.getElementById('menuOverlay')
  const closeMenu = document.getElementById('closeMenu')

  menuToggle && (menuToggle.onclick = () => menuOverlay.classList.add('show'))
  closeMenu && (closeMenu.onclick = () => menuOverlay.classList.remove('show'))

  menuOverlay.onclick = e => {
    if (e.target === menuOverlay) menuOverlay.classList.remove('show')
  }

  document.getElementById("menuRefund").addEventListener("click", () => {
    // refund logic here
    alert("Refund clicked!");
  });

  /* =========================
     DARK MODE (STATEFUL)
  ========================= */
  const menuDark = document.getElementById('menuDark')
  const themeIcon = document.getElementById('themeIcon')
  const themeLabel = document.getElementById('themeLabel')

  function applyTheme(theme) {
    const isDark = theme === 'dark'

    document.body.classList.toggle('dark', isDark)
    localStorage.setItem('theme', theme)

    // update icon
    themeIcon.className = isDark ? 'fa fa-sun' : 'fa fa-moon'

    // update label
    themeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode'
  }

  // INIT on load
  const savedTheme = localStorage.getItem('theme') || 'dark'
  applyTheme(savedTheme)

  // TOGGLE on click
  menuDark?.addEventListener('click', () => {
    const nextTheme =
      document.body.classList.contains('dark') ? 'light' : 'dark'
    applyTheme(nextTheme)
  })

  /* =========================
     CLEAR CACHE
  ========================= */
  document.getElementById('menuClearCache')?.addEventListener('click', () => {
    if (!confirm('This will clear cached data and reload the app. Continue?')) return
    localStorage.clear()
    location.reload()
  })

})()
