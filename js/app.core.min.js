(() => {

  const currentPage = location.pathname.split('/').pop() || 'index.html'
  const params = new URLSearchParams(location.search)
  const from = params.get('from')

  if (currentPage === 'orders.html') return

  const empty = document.createElement('div')
  empty.className = 'empty'
  empty.id = 'emptyText'
  empty.innerText = 'No matching service found'
  document.querySelector('.wrapper')?.appendChild(empty)

  async function loadJSON(path) {
    const res = await fetch(path)
    if (!res.ok) throw new Error(`Failed to load ${path}`)
    return res.json()
  }

  let items = []

  async function loadItems() {

    if (currentPage === 'index.html') {
      const [imei, server, rent] = await Promise.all([
        loadJSON('data/imei-items.json'),
        loadJSON('data/server-items.json'),
        loadJSON('data/rent-items.json')
      ])
      items = [...imei, ...server, ...rent]

    } else if (currentPage === 'imei.html') {
      items = await loadJSON('data/imei-items.json')

    } else if (currentPage === 'server.html') {
      items = await loadJSON('data/server-items.json')

    } else if (currentPage === 'rent.html') {
      items = await loadJSON('data/rent-items.json')
    }

    initGrid()
  }

  function initGrid() {

    items.sort((a, b) => {
      if (!!a.unavailable !== !!b.unavailable) {
        return a.unavailable ? 1 : -1
      }
      return (a.title || '').localeCompare(b.title || '')
    })

    const grid = document.getElementById('grid')
    if (!grid) return
    grid.innerHTML = ''

    items.forEach(item => {

      const a = document.createElement('a')
      a.className = 'card'
      a.dataset.from = item.from || ''

      if (item.from === 'imei' || currentPage === 'imei.html') {
        a.classList.add('card-imei')
      } else if (item.from === 'server' || currentPage === 'server.html') {
        a.classList.add('card-server')
      } else if (item.from === 'rent' || currentPage === 'rent.html') {
        a.classList.add('card-rent')
      }

      const finalLink =
        item.link ||
        (item.from ? `checkout.html?from=${item.from}` : null)

      if (!item.unavailable && finalLink) {
        a.href = finalLink
      } else {
        a.classList.add('disabled')
      }

      /* =========================
         ORDER DATA (FIXED)
      ========================= */
      a.addEventListener('mousedown', e => {
        if (!finalLink || item.unavailable) {
          e.preventDefault()
          return
        }

        const order = {
          service: [item.title, item.subtitle].filter(Boolean).join(' â€“ '),
          unitPrice: item.price
            ? Number(item.price.replace(/[^\d.]/g, ''))
            : null,
          allowQuantity: item.pricingType === 'per_unit',
          requiresIMEI: item.fields?.includes('imei'),
          requiresSerial: item.fields?.includes('serial'),
          requiresUnlockCode: item.fields?.includes('unlock_code'),
          quantity: 1
        }

        sessionStorage.setItem('order', JSON.stringify(order))
      })

      a.innerHTML = `
        <div class="thumb">
          <img src="${item.image || 'img/placeholder.png'}" alt="">
        </div>
        <span>
          ${item.title || ''}
          ${item.subtitle ? `<br>${item.subtitle}` : ''}
        </span>
        ${
          item.price
            ? `<div class="price ${item.unavailable ? 'not-available' : ''}">
                 ${item.price}
               </div>`
            : ''
        }
      `

      grid.appendChild(a)
    })

    const cards = [...grid.querySelectorAll('.card')]
    cards.forEach((card, i) => {
      card.style.animation = 'none'
      card.offsetHeight
      setTimeout(() => {
        card.style.animation = 'cascade .45s ease forwards'
      }, i * 70)
    })
  }

  loadItems().catch(console.error)

  const searchInput = document.querySelector('.search input')

  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.trim().toLowerCase()
      const emptyText = document.getElementById('emptyText')
      const grid = document.getElementById('grid')

      if (!grid) return

      let visibleCount = 0

      ;[...grid.children].forEach(card => {
        const text = card.innerText.toLowerCase()
        const category = (card.dataset.from || '').toLowerCase()

        const isCategoryMatch =
          q === 'imei' || q === 'server' || q === 'rent'
            ? category === q
            : false

        const match =
          q === '' ||
          text.includes(q) ||
          isCategoryMatch

        card.style.display = match ? '' : 'none'
        if (match) visibleCount++
      })

      if (emptyText) {
        emptyText.style.display = visibleCount === 0 ? 'block' : 'none'
      }
    })
  }

})()

document.addEventListener('DOMContentLoaded', () => {
  const wrap = document.querySelector('.wrapper')
  if (!wrap) return

  wrap.classList.remove('slide-exit')
  wrap.classList.add('slide-enter')

  setTimeout(() => {
    wrap.classList.remove('slide-enter')
  }, 200)
})
